# 生活保護調剤券請求書作成システム - コンセプトデザイン

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [背景と課題](#背景と課題)
3. [コンセプト](#コンセプト)
4. [ターゲットユーザー](#ターゲットユーザー)
5. [価値提案](#価値提案)
6. [システムアーキテクチャ](#システムアーキテクチャ)
7. [主要機能](#主要機能)
8. [ユーザー体験設計](#ユーザー体験設計)
9. [技術選定理由](#技術選定理由)
10. [今後の展望](#今後の展望)

---

## プロジェクト概要

### プロジェクト名
**生活保護調剤券請求書自動作成システム**
（Welfare Dispensing Invoice Generator）

### 目的
調剤薬局における生活保護（公費12）調剤券の請求業務を、完全自動化することで、薬局スタッフの事務作業負担を大幅に削減し、請求ミスを防止する。

### 開発期間
- **企画開始**: 2025年1月
- **初期実装**: 2025年2月
- **Webアプリ版**: 2025年2月（現バージョン）

### 開発者
関根 (sekine53629)

---

## background と課題

### 調剤薬局の現状

調剤薬局では、生活保護受給者の調剤券に基づいて市町村に請求を行う業務が存在します。

#### 従来の業務フロー

1. **レセプトデータCSV受領** - 月次で国保連合会等からCSVデータを受け取る
2. **手動フィルタリング** - 生活保護対象者を目視で抽出
3. **Excelへの手入力** - 患者情報を1件ずつExcelテンプレートに入力
4. **重複チェック** - 同一患者・同一日の処方が複数ある場合、手動で除外
5. **書類作成** - 市町村指定フォーマットに整形
6. **電子請求** - LoGoフォームで送信

#### 主な課題

| 課題 | 影響 |
|------|------|
| **手作業による入力ミス** | 患者名、住所、保険者番号の誤入力 → 請求差戻し |
| **フィルタリング漏れ** | 旭川市以外のデータ混入 → 請求対象外データの送信 |
| **重複チェック漏れ** | 同一患者の複数医療機関データを重複請求 |
| **時間的コスト** | 1件あたり平均3-5分 × 月間50-100件 = **3-8時間/月** |
| **他公費併用の判断困難** | 21（精神）・15（更生）等との併用時、請求額を誤算定 |
| **テンプレート管理** | 毎回Excelテンプレートを探して選択する手間 |

---

## コンセプト

### キャッチコピー
**「3クリックで請求完了。薬局業務を、もっとシンプルに。」**

### コアコンセプト

#### 1. **ゼロ入力、ゼロミス**
- ユーザーは一切データ入力しない
- CSVアップロードのみで全自動処理
- ヒューマンエラーの完全排除

#### 2. **1画面完結**
- スクロールだけで全情報にアクセス
- 画面遷移なし、迷わないUI
- 必要な情報・アクションがすべて1画面に集約

#### 3. **インテリジェント・フィルタリング**
- 旭川市判定（保険者番号 + 住所フォールバック）
- 重複除外（患者番号 + 調剤日 + 氏名）
- 他公費併用の自動警告

#### 4. **組み込みテンプレート**
- 旭川市公式Excelテンプレート内蔵
- テンプレート選択不要
- アプリ起動後すぐに使用可能

#### 5. **透明性と柔軟性**
- すべてのフィルタリング結果を可視化
- チェックボックスで個別除外可能
- アーカイブで処理履歴を保持

---

## ターゲットユーザー

### プライマリユーザー
**調剤薬局の事務スタッフ**
- 年齢層: 25-55歳
- ITリテラシー: 中程度（Excel操作は可能）
- 課題: 月次の請求業務に時間を取られている
- ニーズ: 簡単・確実・速い請求書作成

### セカンダリユーザー
**薬局管理者・薬剤師**
- 請求ミスのチェック・承認業務
- 統計データの確認
- 処理履歴の監査

---

## 価値提案

### ユーザーへの価値

#### 時間削減
- **従来**: 月間3-8時間
- **本システム**: 月間10-15分（95%削減）

#### ミス削減
- **従来**: 入力ミス率 5-10%
- **本システム**: 入力ミス率 0%（自動化）

#### ストレス削減
- 単純作業からの解放
- 請求差戻しリスクの排除
- いつでも処理履歴を確認可能

### 組織への価値

#### コスト削減
- 人件費削減（月間3-8時間分）
- 差戻し対応コスト削減

#### 品質向上
- 請求精度100%
- コンプライアンス強化

#### データ蓄積
- 処理履歴の自動保存
- 統計分析の基盤データ

---

## システムアーキテクチャ

### アーキテクチャ方針

```
┌─────────────────────────────────────────────────┐
│           ユーザー（ブラウザ）                    │
└─────────────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────┐
│        フロントエンド（Vanilla JS + ES6）         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │CSV Parser│  │Data Filter│ │Excel Gen │      │
│  └──────────┘  └──────────┘  └──────────┘      │
└─────────────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────┐
│       クライアントサイドストレージ                 │
│  ┌──────────────┐  ┌─────────────────┐         │
│  │ IndexedDB    │  │ localStorage    │         │
│  │ (アーカイブ)  │  │ (設定データ)     │         │
│  └──────────────┘  └─────────────────┘         │
└─────────────────────────────────────────────────┘
```

### 技術スタック

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| **フロントエンド** | Vanilla JavaScript (ES6+) | 軽量・高速・依存ゼロ |
| **CSVパース** | Papa Parse | Shift-JIS対応、高速 |
| **Excel生成** | ExcelJS | クライアントサイドで完結 |
| **データ保存** | IndexedDB (localforage) | ブラウザ永続化、高速 |
| **UI** | CSS3 + Flexbox/Grid | レスポンシブ、モダン |

### モジュール構成

```
webapp-version/
├── index.html                    # エントリーポイント
├── template/
│   └── tyouzai_excel_v2.xlsx    # 組み込みテンプレート
└── src/
    ├── js/
    │   ├── app.js               # メインコントローラー
    │   ├── csv-parser.js        # CSVパース（Shift-JIS対応）
    │   ├── data-filter.js       # データフィルタリング
    │   ├── excel-generator.js   # Excel生成
    │   ├── archive-manager.js   # 処理履歴管理
    │   ├── config-manager.js    # 設定管理
    │   └── utils.js             # 共通ユーティリティ
    └── css/
        ├── main.css             # 基本スタイル
        └── components.css       # コンポーネントスタイル
```

---

## 主要機能

### 1. CSVデータ処理

#### 入力
- **ドラッグ&ドロップ対応**
- **ファイル選択ダイアログ**
- **Shift-JIS / UTF-8 自動判定**

#### パース
- Papa Parseによる高速パース
- エラーハンドリング（不正フォーマット検出）

#### データクリーニング
- 半角カナ→全角カナ変換
- トリム処理（前後空白削除）
- 住所正規化

### 2. インテリジェント・フィルタリング

#### 旭川市判定
```javascript
優先順位1: 保険者番号チェック
  - 12016010（旭川市）
  - 12012019（旭川市・後期高齢者）

優先順位2: 住所文字列チェック（フォールバック）
  - 住所に「旭川市」を含む
```

#### 重複除外（2回目請求時）
```javascript
ユニークキー = 受給者番号 + 調剤年月日 + 氏名
```

#### 他公費併用検出
- 公費番号: 21（精神通院）、15（更生医療）、16（育成医療）、54（難病）
- 該当患者を黄色背景でハイライト表示
- チェックボックスでデフォルトON（手動除外可能）

### 3. 1画面UI

#### レイアウト構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー情報バー                                  │
│ ファイル名 | 請求回数 | [🔄 新規作成]              │
├─────────────────────────────────────────────────┤
│ 統計情報（コンパクト）                             │
│ 総数: 120 | 請求対象: 85 | 重複除外: 15           │
├──────────────────────────┬─────────────────────┤
│ 患者リスト               │  アクションパネル    │
│ ┌──────────────────────┐ │ ┌─────────────────┐ │
│ │ [検索ボックス]        │ │ │ Excel出力       │ │
│ └──────────────────────┘ │ │ 対象: 85件      │ │
│ ┌──────────────────────┐ │ │ [ダウンロード]  │ │
│ │ ☑ 全選択             │ │ └─────────────────┘ │
│ └──────────────────────┘ │ ┌─────────────────┐ │
│ ┌──────────────────────┐ │ │ 請求先リンク    │ │
│ │ 患者テーブル          │ │ │ 📝 電子請求     │ │
│ │ ☑ 佐藤花子 [精]      │ │ │ 🔐 ログイン     │ │
│ │ ☑ 田中太郎           │ │ │ 📄 案内ページ   │ │
│ │ ☑ 鈴木美咲 [更]      │ │ │ 📞 0166-25-9121 │ │
│ │ ...                  │ │ └─────────────────┘ │
│ └──────────────────────┘ │ ┌─────────────────┐ │
│ ┌──────────────────────┐ │ │ 注意事項        │ │
│ │ 凡例                 │ │ │ ・シート名変更× │ │
│ │ [精]=21 [更]=15      │ │ │ ・氏名に半角空白│ │
│ │ [育]=16 [難]=54      │ │ └─────────────────┘ │
│ └──────────────────────┘ │                     │
└──────────────────────────┴─────────────────────┘
```

### 4. Excel生成

#### テンプレート処理
- **組み込みテンプレート**: `tyouzai_excel_v2.xlsx`（旭川市公式）
- **自動読み込み**: アプリ起動時にfetchで取得

#### データ書き込み
```javascript
患者データをExcelJSで書き込み:
  - セルA6～: 通番
  - セルB6～: 受給者番号
  - セルC6～: 氏名
  - セルD6～: 生年月日
  - セルE6～: 調剤年月日
  - セルF6～: 処方箋医療機関名
  - セルG6～: 備考
```

#### ファイル名生成
```
フォーマット: 調剤券_旭川市_YYYYMM_薬局名_N回目.xlsx
例: 調剤券_旭川市_202502_さくら薬局_1回目.xlsx
```

### 5. アーカイブ管理

#### 保存内容
- 処理日時
- CSVファイル名
- 請求回数
- 請求対象件数
- 生成されたExcelファイル（Blob）

#### IndexedDB構造
```javascript
{
  id: "202502_さくら薬局_1回目",
  timestamp: "2025-02-15T10:30:00Z",
  csvFileName: "レセプトデータ202502.csv",
  batchNumber: 1,
  patientCount: 85,
  excelBlob: Blob {...},
  metadata: {
    pharmacyName: "さくら薬局",
    medicalCode: "0123456789"
  }
}
```

#### アーカイブ一覧表示
- 月別フィルタリング
- 再ダウンロード機能
- 一括クリア機能

### 6. 設定管理

#### 保存項目
- **薬局名**: Excel出力時のファイル名に使用
- **医療機関コード**: 将来の拡張用

#### 保存先
- localStorage（JSON形式）

---

## ユーザー体験設計

### ユーザージャーニー

#### 初回利用時

```
1. アプリを開く
   ↓
2. 設定タブで薬局名を登録（1回のみ）
   ↓
3. 請求書作成タブでCSVをドラッグ&ドロップ
   ↓
4. 請求回数を選択（1回目/2回目）
   ↓
5. 自動フィルタリング完了（1画面表示）
   ↓
6. 他公費ありの患者をチェック確認
   ↓
7. Excelダウンロードボタンクリック
   ↓
8. 生成されたExcelファイルを確認
   ↓
9. 電子請求フォームリンクをクリック
   ↓
10. LoGoフォームでアップロード → 完了
```

**所要時間**: 約2-3分

#### 2回目以降

```
1. アプリを開く
   ↓
2. CSVをドラッグ&ドロップ
   ↓
3. 請求回数を選択
   ↓
4. Excelダウンロード
   ↓
5. 電子請求
```

**所要時間**: 約1分

### UX設計原則

#### 1. **即座のフィードバック**
- アップロード時: プログレスバー表示
- 処理完了時: 成功モーダル表示
- エラー時: 具体的なエラーメッセージ

#### 2. **予測可能な挙動**
- ボタンラベルが明確（「Excelダウンロード」「新規作成」）
- アクションの結果が予測可能
- 元に戻せる操作（リセットボタン）

#### 3. **視覚的階層**
- 重要情報は大きく・太く
- セカンダリ情報は小さく・薄く
- カラーでステータスを表現（成功=緑、警告=黄、エラー=赤）

#### 4. **アクセシビリティ**
- キーボード操作対応（Tab, Enter）
- コントラスト比確保（WCAG AA準拠）
- レスポンシブデザイン（モバイル対応）

---

## 技術選定理由

### なぜVanilla JavaScriptか？

#### メリット
1. **依存ゼロ**: フレームワーク不要、ビルド不要
2. **軽量**: 初回ロード高速（<100KB）
3. **永続性**: フレームワークの廃止リスクなし
4. **学習コスト低**: 標準Web技術のみ

#### デメリットと対策
| デメリット | 対策 |
|-----------|------|
| 状態管理が複雑 | グローバル変数を最小限に、関数型プログラミング |
| コンポーネント化困難 | モジュール分割（ES6 modules） |
| 大規模開発に不向き | 本システムは小規模なので問題なし |

### なぜクライアントサイド完結か？

#### メリット
1. **プライバシー保護**: 患者データがサーバーに送信されない
2. **コスト削減**: サーバー不要、インフラ費用ゼロ
3. **オフライン動作**: ネットワーク不要（初回読み込み後）
4. **シンプルなデプロイ**: HTMLファイルを開くだけ

#### デメリットと対策
| デメリット | 対策 |
|-----------|------|
| データ同期不可 | 薬局ごとに独立運用（同期不要） |
| バックアップ困難 | アーカイブのエクスポート機能（将来実装） |
| 性能限界 | 数千件程度なら問題なし |

### なぜPapa Parse + ExcelJSか？

#### Papa Parse（CSV）
- Shift-JIS対応（日本の医療システム標準）
- 高速（Web Worker対応）
- エラーハンドリング優秀

#### ExcelJS（Excel）
- クライアントサイドで完結
- 複雑な書式設定可能
- テンプレート読み込み・書き込み両対応

---

## 今後の展望

### フェーズ1: 基本機能実装 ✅ **完了**
- CSV読み込み・フィルタリング
- Excel生成・ダウンロード
- 1画面UI
- アーカイブ管理
- 組み込みテンプレート

### フェーズ2: 利便性向上（2025年Q2）
- [ ] 患者データの検索・ソート機能強化
- [ ] 統計ダッシュボード（月別請求件数グラフ）
- [ ] アーカイブのエクスポート/インポート
- [ ] テンプレート更新通知機能

### フェーズ3: 多機能化（2025年Q3-Q4）
- [ ] 複数市町村対応（札幌市、函館市等）
- [ ] 公費併用時の請求額自動計算
- [ ] PDF出力機能
- [ ] ブラウザ拡張機能化（Chrome Extension）

### フェーズ4: 高度化（2026年～）
- [ ] 機械学習による請求漏れ検出
- [ ] 他薬局とのデータ共有（匿名化）
- [ ] クラウド同期オプション（希望者のみ）
- [ ] モバイルアプリ版（PWA）

---

## 成功指標（KPI）

### ユーザー視点
- **時間削減率**: 95%以上（8時間 → 15分）
- **エラー率**: 0%（手動入力ミス完全排除）
- **ユーザー満足度**: NPS 50以上

### システム視点
- **処理速度**: 100件のデータを3秒以内に処理
- **稼働率**: 99.9%以上（クライアントサイドのため高稼働率）
- **エラー発生率**: 1%未満

### ビジネス視点
- **導入薬局数**: 10薬局以上（2025年内）
- **月間処理件数**: 1,000件以上
- **コスト削減額**: 月間30万円以上（人件費換算）

---

## まとめ

本システムは、**調剤薬局の請求業務を95%削減する**ことを目的とした、クライアントサイド完結型のWebアプリケーションです。

### 3つの柱

1. **ゼロ入力・ゼロミス**: 完全自動化によるヒューマンエラー排除
2. **1画面完結**: 迷わない直感的UI
3. **組み込みテンプレート**: 設定不要、即使用可能

### 目指す未来

**「請求業務に悩む全国の薬局スタッフを、テクノロジーで解放する」**

このシステムが、調剤薬局の業務効率化の第一歩となり、スタッフの皆様がより本質的な業務（患者対応、医療安全）に集中できる環境を実現します。

---

**Document Version**: 1.0
**Last Updated**: 2025-02-15
**Author**: 関根 (sekine53629)
