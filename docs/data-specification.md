# データ仕様書 - 調剤券請求書作成システム

## 公費負担医療制度 番号体系

### 法別番号一覧

| 法別番号 | 制度名 | 自己負担 | 備考 |
|---------|--------|---------|------|
| 10 | 結核患者適正医療 | - | - |
| **12** | **生活保護（医療扶助）** | **なし** | **本システムの主要対象** |
| 13 | 戦傷病者特別援護法 | - | - |
| **15** | **更生医療（自立支援）** | **10%（上限あり）** | **フラグ判定対象** |
| **16** | **育成医療（自立支援）** | **10%（上限あり）** | **フラグ判定対象** |
| 18-19 | 原爆医療 | - | - |
| **21** | **精神通院医療（自立支援）** | **10%（上限あり）** | **フラグ判定対象** |
| 25 | 中国残留邦人医療支援 | - | - |
| 30 | 心神喪失者医療観察法 | - | - |
| 38 | 肝炎治療特別促進 | - | - |
| 51 | 特定疾患 | - | 旧制度 |
| 52 | 小児特定疾患 | - | 旧制度 |
| 53 | 児童福祉法（措置医療） | - | - |
| **54** | **難病法（指定難病）** | **2割（上限あり）** | **フラグ判定対象** |
| 66 | 石綿健康被害救済法 | - | - |

### 本システムでの使用

#### 必須抽出条件
- **公費種別番号 = 12（生活保護）**

#### フラグ判定
- **自立支援フラグ**: 15, 16, 21 のいずれかが存在
- **重障フラグ**: 54 が存在

---

## 保険者番号体系

### 旭川市の保険者番号（複数存在）

| 保険者番号 | 名称 | 用途 | 備考 |
|-----------|------|------|------|
| **12016010** | **旭川市** | **国民健康保険** | **主要番号** |
| **12012019** | **旭川市（旧番号）** | **国民健康保険/後期高齢者** | **旧社会保険事務所管轄** |

**重要**: 旭川市の判定には**両方の番号**を含める必要があります。

### 札幌市の保険者番号（区ごとに異なる）

| 保険者番号 | 区名 |
|-----------|------|
| 12011011 | 中央区 |
| 12011029 | 北区 |
| 12011037 | 東区 |
| 12011045 | 白石区 |
| 12011052 | 豊平区 |
| 12011060 | 南区 |
| 12011078 | 西区 |
| 12011086 | 厚別区 |
| 12011094 | 手稲区 |
| 12011102 | 清田区 |

### 保険者番号形式
- **桁数**: 8桁
- **先頭2桁**: 都道府県コード（北海道 = 01）
- **3-8桁**: 保険者識別番号

---

## 住所判定ロジック（新仕様）

### 現在の問題点
現在の実装では「住所」フィールドから文字列「旭川市」を検索していますが、以下の問題があります：
- 住所が空欄の場合に判定不可
- 表記ゆれ（「旭川巿」など）に対応できない
- 保険者番号からの判定の方が確実

### 新仕様: 保険者番号による判定

#### 判定ロジック（優先度順）

1. **保険者番号による判定（推奨）**
   ```
   保険者番号 IN ["12016010", "12012019"] → 旭川市
   ```

2. **住所による判定（フォールバック）**
   ```
   住所フィールドに「旭川市」が含まれる → 旭川市
   ```

#### 実装擬似コード
```javascript
function isAsahikawa(record) {
  // 優先1: 保険者番号（複数対応）
  const insurerNumber = record.getField(10); // 保険者番号
  const asahikawaInsurerNumbers = ["12016010", "12012019"];

  if (asahikawaInsurerNumbers.includes(insurerNumber)) {
    return true;
  }

  // 優先2: 住所（フォールバック）
  const address = record.getField(48); // 住所
  if (address && address.includes("旭川市")) {
    return true;
  }

  return false;
}
```

---

## CSVデータ構造（70列）

### 主要フィールドマッピング

| 列番号 | フィールド名 | 例 | 備考 |
|-------|-------------|-----|------|
| 10 | 保険者番号 | 12016010 | **旭川市判定に使用** |
| 22 | 第一公費種別番号 | 12 | **生活保護判定** |
| 26 | 第二公費種別番号 | 21 | 自立支援など |
| 30 | 第三公費種別番号 | 54 | 難病など |
| 39 | 患者氏名 | 山田太郎 | - |
| 40 | 患者カナ氏名 | ヤマダタロウ | - |
| 43 | 生年月日 | 1980/05/15 | - |
| 48 | 住所 | 北海道旭川市○条○丁目 | フォールバック用 |
| 56 | 調剤年月日 | 2025/02(10) | - |
| 66 | 医療機関名称 | ○○病院 | - |

---

## フィルタリングロジック（最終版）

### CSVデータの前提条件

**重要**: 本システムに投入されるCSVは以下の条件を満たしています:
- ✅ すでに公費12（生活保護）を含むデータのみ
- ✅ 生活保護受給者のみが記載されている
- → **生活保護判定は不要**

### 抽出条件（シンプル）

#### 1. 旭川市判定（唯一の必須判定）
```
保険者番号 IN ["12016010", "12012019"] OR
住所に「旭川市」を含む
```

#### 2. 重複除外（2回目請求のみ）
```
前回処理したユニークキーと一致しない
```

**それだけ！**

### フラグ設定（参考情報のみ）

#### 自立支援フラグ
```
第一公費種別番号 IN [15, 16, 21] OR
第二公費種別番号 IN [15, 16, 21] OR
第三公費種別番号 IN [15, 16, 21]
```
**用途**: ⚠️ 警告表示 - 実レセプト確認推奨

#### 重障フラグ
```
第一公費種別番号 = 54 OR
第二公費種別番号 = 54 OR
第三公費種別番号 = 54
```
**用途**: ⚠️ 警告表示 - 実レセプト確認推奨

#### 社保併用フラグ
```
保険者番号が存在 AND 保険者番号 != ""
```
**用途**: 📋 情報表示のみ

**重要な注意**:
- これらのフラグは「公費が登録されている」ことを示すのみ
- 実際に旭川市（12）への請求が発生するかは不明
- ユーザーがチェックボックスで手動判断する材料として使用

---

## テストデータ要件

### テストCSV作成条件

1. **患者数**: 10-15名
2. **パターン分布**:
   - 旭川市 + 生活保護（公費12）: 5-7名 ✅ **抽出対象**
   - 旭川市 + 他公費: 2-3名 ❌ **除外対象**
   - 他市町村 + 生活保護: 2-3名 ❌ **除外対象**
   - その他: 1-2名 ❌ **除外対象**

3. **フラグパターン**:
   - 自立支援フラグあり: 2-3名
   - 重障フラグあり: 1-2名
   - 両方あり: 1名

4. **調剤年月日**: 2025/02(XX) 形式で統一

5. **名前**: 実在しそうな日本人名

---

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|---------|------|
| 2025-01-15 | 初版作成 | 公費番号・保険者番号体系の明確化 |
| 2025-01-15 | 住所判定を保険者番号優先に変更 | データの信頼性向上 |

