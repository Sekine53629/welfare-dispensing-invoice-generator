# 生活保護調剤券請求書自動作成システム 要件定義書

**文書バージョン**: 1.0
**作成日**: 2025年2月
**対象システム**: VBA版・Webアプリ版共通

---

## 1. システム概要

### 1.1 目的
生活保護受給者の調剤券に基づく薬局の請求書を、CSVデータから自動生成し、旭川市への請求業務を効率化する。

### 1.2 背景
- 現在、調剤券請求書の作成は手作業で行われており、時間がかかる
- CSVデータのパース処理に不備があり、データの不整合が発生
- 月2回の請求業務（月中・月末）があり、重複請求の防止が必要
- 個人情報を含むため、5年間のローカルアーカイブが法的に必要

### 1.3 適用範囲
- 旭川市内の薬局における生活保護調剤券請求業務
- 北海道国保連合会から提供されるCSVデータの処理

---

## 2. 機能要件

### 2.1 基本機能

#### F-001: CSVデータ読み込み
**優先度**: 必須
**説明**: 北海道国保連合会から提供される調剤券CSVファイルを読み込む

**詳細要件**:
- CSV形式: カンマ区切り、Shift-JISエンコーディング
- 不完全なシングルクォート処理への対応
- カンマを含むフィールド（住所等）の正しい解析
- データ列数: 70列（ヘッダー行を除く）
- 対応する主要フィールド:
  - 列1: 制度区分（R1）
  - 列10: 患者氏名
  - 列11: 患者カナ氏名
  - 列12: 生年月日
  - 列13: 年齢
  - 列14: 性別
  - 列22: 第一公費種別番号
  - 列26: 第二公費種別番号
  - 列30: 第三公費種別番号
  - 列34: 医療機関名
  - 列38: 患者住所
  - 列40: 患者郵便番号
  - 列56: 診療年月日
  - 列58: 患者受給者番号
  - 列65: 医療機関コード

**入力条件**:
- ファイル選択ダイアログから選択可能
- ドラッグ&ドロップ対応（Webアプリ版）

**出力**:
- パース済みデータオブジェクト/配列

**エラー処理**:
- ファイル形式不正の検出
- 必須列の欠損チェック
- 文字エンコーディングエラーの処理

---

#### F-002: 旭川市生活保護受給者フィルタリング
**優先度**: 必須
**説明**: CSVデータから旭川市の生活保護受給者のみを抽出

**詳細要件**:
- 住所フィールド（列38）に「旭川市」を含むレコードのみ抽出
- 公費種別番号による判定:
  - 列22（第一公費種別番号）が「12」の場合 → 生活保護
  - 列26（第二公費種別番号）が「12」の場合 → 生活保護
  - 列30（第三公費種別番号）が「12」の場合 → 生活保護
  - いずれか1つでも「12」であれば対象

**判定ロジック**:
```
IF (住所 CONTAINS "旭川市") AND (公費1 == "12" OR 公費2 == "12" OR 公費3 == "12")
  THEN 対象レコード
ELSE
  THEN 除外
```

**出力**:
- フィルタリング済みレコード配列
- 抽出件数の表示

---

#### F-003: 自立支援医療・重度障害者判定
**優先度**: 必須
**説明**: 公費種別番号から自立支援医療・重度障害者を判定し、請求書に○印を付ける

**詳細要件**:

**自立支援医療の判定**:
- 公費種別番号が以下のいずれかの場合、「自立支援」欄に○
  - 「21」（精神通院医療）
  - 「15」（更生医療）
  - 「16」（育成医療）
- 3つの公費番号（列22, 26, 30）のいずれかに該当すればOK

**重度障害者の判定**:
- 公費種別番号が「54」の場合、「重障」欄に○
- 3つの公費番号（列22, 26, 30）のいずれかに該当すればOK

**出力**:
- 各レコードに判定フラグを付与

---

#### F-004: 医療機関コード処理
**優先度**: 必須
**説明**: 医療機関コードから先頭の「01」を削除

**詳細要件**:
- CSVの列65（医療機関コード）から先頭2桁が「01」の場合、削除
- 例: 「0112918784」 → 「12918784」
- 薬局の医療機関コード（設定値）にも同様の処理を適用

**処理ロジック**:
```
IF 医療機関コード.startsWith("01")
  THEN 医療機関コード = 医療機関コード.substring(2)
```

---

#### F-005: 重複請求チェック
**優先度**: 必須
**説明**: 月1回目の請求時に処理した患者データを記録し、2回目の請求時に重複を除外

**詳細要件**:
- 重複判定キー:
  - 受給者番号（列58）
  - 診療年月日（列56）
  - 患者氏名（列10）
- 1回目請求データをローカルに保存（JSON/CSV形式）
- 2回目請求時に既存データと照合
- 重複レコードをスキップまたは警告表示

**データ保存形式**:
```json
{
  "month": "2025-02",
  "firstBatch": {
    "processedDate": "2025-02-20",
    "records": [
      {
        "recipientNumber": "0412569",
        "treatmentDate": "2025/02(10)",
        "patientName": "AA AA"
      }
    ]
  }
}
```

**UI要件**:
- 「1回目請求」「2回目請求」の選択ボタン
- 重複データ件数の表示
- 重複レコード一覧のプレビュー機能

---

#### F-006: テンプレート設定
**優先度**: 必須
**説明**: Excelテンプレートファイルを設定し、請求書のフォーマットを定義

**詳細要件**:
- テンプレートファイル形式: `.xltx` (Excel Template)
- 設定項目:
  - 薬局名（セルB1）
  - 医療機関コード（セルB2）
  - テンプレートファイルパス（セルB3）
  - 保存フォルダパス（セルB4）

**テンプレート構造**:
- 11行目から患者データ転記開始
- 各行のデータ配置:
  - 列2: 薬局名
  - 列3: 薬局医療機関コード
  - 列4: 診療医療機関名
  - 列5: 診療医療機関コード
  - 列6: 受給者番号
  - 列7: 患者氏名
  - 列8: 患者カナ氏名
  - 列9: 生年月日
  - 列10: 診療年月日
  - 列12: 自立支援（○/空白）
  - 列13: 重障（○/空白）

---

#### F-007: 請求書データ生成
**優先度**: 必須
**説明**: フィルタリング済みデータをテンプレートに転記し、請求書を生成

**詳細要件**:
- 1レコード = 1行として転記
- 11行目から順次追加
- 空白行の自動処理
- データクレンジング:
  - 先頭・末尾の空白削除
  - シングルクォート削除
  - 半角カナ → 全角カナ変換
  - 括弧の置換: `(` → `/`, `)` → 削除

**文字列処理関数**:
- `FixKana()`: シングルクォート削除 + 括弧処理 + 全角変換
- `TrimSpaces()`: 空白削除
- `FixKanaAndTrim()`: 上記の組み合わせ
- `RemoveLeading01()`: 先頭01削除

---

#### F-008: Excelファイル保存
**優先度**: 必須
**説明**: 生成した請求書をExcelファイル（.xlsx）として保存

**詳細要件**:
- ファイル名形式: `{YYYYMMDD}_tyouzai_excel_v2.xlsx`
  - 例: `20250220_tyouzai_excel_v2.xlsx`
- 保存先: 設定した保存フォルダ
- ファイル形式: `.xlsx` (Excel Open XML Workbook)
- 上書き確認ダイアログ表示

---

#### F-009: アーカイブ機能
**優先度**: 必須
**説明**: 請求データを5年間ローカル保存し、個人情報保護に対応

**詳細要件**:
- アーカイブ対象:
  - 元CSVファイル
  - 生成したExcelファイル
  - 処理ログ（日時、件数、エラー等）
- 保存ディレクトリ構造:
```
archive/
  └── 2025/
      ├── 202502/
      │   ├── batch1_20250220/
      │   │   ├── source.csv
      │   │   ├── output.xlsx
      │   │   └── process.log
      │   └── batch2_20250228/
      │       ├── source.csv
      │       ├── output.xlsx
      │       └── process.log
      └── 202503/
          └── ...
```

- 5年経過後の自動削除機能（オプション）
- アーカイブ一覧表示機能
- アーカイブの復元機能

---

### 2.2 拡張機能（優先度: 推奨）

#### F-010: PDF出力
**説明**: 生成した請求書をPDF形式で出力

#### F-011: データプレビュー
**説明**: CSV読み込み後、データ内容を画面で確認

#### F-012: 統計情報表示
**説明**: 処理件数、公費種別の内訳、医療機関別集計等を表示

#### F-013: エラーログ出力
**説明**: 処理中のエラーをログファイルに記録

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

| 項目 | 要件 |
|-----|------|
| CSV読み込み速度 | 1000件のレコードを5秒以内に処理 |
| 請求書生成速度 | 100件の請求書を30秒以内に生成 |
| ファイルサイズ | 出力Excelファイルは10MB以下 |

### 3.2 可用性要件

| 項目 | 要件 |
|-----|------|
| 動作環境 | Windows 10/11、Excel 2016以降（VBA版） |
| ブラウザ対応 | Chrome/Edge/Firefox最新版（Webアプリ版） |
| オフライン動作 | 完全オフライン対応必須（個人情報保護） |

### 3.3 セキュリティ要件

| 項目 | 要件 |
|-----|------|
| データ保存 | ローカル環境のみ（クラウド禁止） |
| アクセス制御 | ファイルシステムレベルのアクセス権限 |
| データ暗号化 | アーカイブデータの暗号化（推奨） |
| 個人情報保護 | 5年間保管後の確実な削除 |

### 3.4 保守性要件

| 項目 | 要件 |
|-----|------|
| コード管理 | Git管理、バージョン管理 |
| ドキュメント | README、使用マニュアル、API仕様書 |
| テスト | 単体テスト、結合テスト |
| エラー処理 | 全ての例外を適切にキャッチ |

### 3.5 ユーザビリティ要件

| 項目 | 要件 |
|-----|------|
| 操作性 | 3クリック以内で主要機能にアクセス |
| エラーメッセージ | 日本語で分かりやすく表示 |
| ヘルプ | 操作ガイドの提供 |
| 処理進捗 | プログレスバー表示 |

---

## 4. データ要件

### 4.1 入力CSVデータ仕様

| 項目 | 仕様 |
|-----|------|
| ファイル形式 | CSV（カンマ区切り） |
| 文字エンコーディング | Shift-JIS |
| 改行コード | CR+LF（Windows） |
| ヘッダー行 | 1行目: 列番号、8行目: 項目名 |
| データ行 | 2-7行目（サンプル） |
| 列数 | 70列 |
| クォート処理 | シングルクォート（不完全な場合あり） |

### 4.2 出力Excelファイル仕様

| 項目 | 仕様 |
|-----|------|
| ファイル形式 | .xlsx（Excel 2007以降） |
| シート数 | 1シート |
| データ開始行 | 11行目 |
| 最大行数 | 1,048,576行（Excel制限） |

### 4.3 アーカイブデータ仕様

| 項目 | 仕様 |
|-----|------|
| 保存形式 | 元ファイルそのまま + JSON/CSVログ |
| 圧縮 | ZIP圧縮（オプション） |
| 暗号化 | AES-256（推奨） |
| 保存期間 | 5年間（1,825日） |

---

## 5. 制約事項

### 5.1 技術的制約

1. **VBA版**:
   - Microsoft Office参照ライブラリへの依存を最小化
   - FileDialogの代替実装が必要な場合あり
   - CSVパーサーは自前実装

2. **Webアプリ版**:
   - 完全なクライアントサイド処理（サーバー不要）
   - ローカルストレージまたはIndexedDBを使用
   - ブラウザのファイルアクセス制限に対応

### 5.2 業務上の制約

1. **請求スケジュール**:
   - 月2回実施（20日前後・月末午前中）
   - 提出期限厳守のため、エラー時の復旧が重要

2. **データ提供**:
   - 北海道国保連合会からのCSVは既存フォーマット
   - フォーマット変更時の対応が必要

3. **法的要件**:
   - 個人情報保護法に準拠
   - 5年間の記録保管義務

---

## 6. 用語集

| 用語 | 説明 |
|-----|------|
| 調剤券 | 生活保護受給者が薬局で薬剤を受け取る際に使用する券 |
| 受給者番号 | 生活保護受給者に割り当てられた一意の番号 |
| 公費種別番号 | 公費負担医療の種別を示す番号（12=生活保護、21=自立支援等） |
| 医療機関コード | 医療機関・薬局を識別する10桁のコード |
| 重障 | 重度心身障害者医療費助成制度 |
| 自立支援 | 自立支援医療制度（精神通院、更生、育成） |

---

## 7. 実装方針

### 7.1 VBA版

- **アーキテクチャ**: モジュール分割
  - `Module_CSVParser`: CSV解析専用
  - `Module_DataFilter`: フィルタリング処理
  - `Module_ExcelExport`: Excel出力処理
  - `Module_Archive`: アーカイブ処理
  - `Module_Main`: メイン制御

- **依存ライブラリ**: 標準VBAのみ（参照設定不要）

### 7.2 Webアプリ版

- **技術スタック**:
  - HTML5 + CSS3
  - JavaScript (ES6+)
  - Papa Parse（CSVパース）
  - ExcelJS（Excel生成）
  - localforage（データ永続化）

- **アーキテクチャ**: シングルページアプリケーション（SPA）
  - `index.html`: メインUI
  - `app.js`: アプリケーションロジック
  - `csv-parser.js`: CSV処理モジュール
  - `excel-generator.js`: Excel生成モジュール
  - `archive-manager.js`: アーカイブ管理モジュール

---

## 8. 今後の検討事項

1. **クラウド連携**（将来的）:
   - セキュアなクラウドストレージへの暗号化バックアップ

2. **API連携**:
   - 国保連合会からのデータ自動取得API

3. **多言語対応**:
   - UI の英語対応

4. **モバイル対応**:
   - タブレット端末での操作

---

**承認者**: _______________
**承認日**: _______________
