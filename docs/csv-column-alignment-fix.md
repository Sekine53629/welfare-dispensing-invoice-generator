# CSV列ずれ問題の修正

## 問題の概要

CSVファイルをPapa Parseで解析した際、**列がずれて正しくパースされない**問題が発生していました。

### 症状

```
期待される結果（70列）:
列1  列2  列3  ...  列10        列11            列12              ...
R1   1    154848    佐藤 花子    サトウ ハナコ    昭和35年5月10日    ...

実際の結果（68-69列）:
列1  列2  列3  ...  列10                    列11              ...
R1   1    154848    佐藤 花子,サトウ ハナコ  昭和35年5月10日    ...
                    ^^^^^^^^^^^^^^^^^^^^^^^^ フィールドが結合されている
```

## 原因分析

### 実際のCSVフォーマット

レセプトシステムから出力されるCSVは以下の特徴があります：

1. **70列固定フォーマット**
2. **文字列フィールドにシングルクォート（`'`）が含まれる**
3. **シングルクォートが不完全**（開始クォートなし、終了クォートのみ）

### 具体例

```csv
...,佐藤 花子',サトウ ハナコ',昭和35年5月10日',...
    ^^^^^^^^  ^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^
    終了のみ   終了のみ         終了のみ
```

### Papa Parseの動作

Papa Parseが`quoteChar: "'"`で設定されている場合：

1. `佐藤 花子'` を検出
2. 開始クォートがないため、**次のフィールドまで探索**
3. `佐藤 花子',サトウ ハナコ'` を1つのフィールドとして結合
4. 結果：列数が減り、列がずれる

### エラーログ例

```
警告: 行 2 のフィールド数が不足（68列）
警告: 行 3 のフィールド数が不足（69列）
```

---

## 解決策

### アプローチ：**前処理で不完全なクォートを削除**

Papa Parseに渡す前に、CSVテキストからすべてのシングルクォート（`'`）を削除します。

### 実装

#### webapp版: `csv-parser.js`

```javascript
export async function parseCSVFile(file, options = {}) {
  // STEP 1: ファイルをテキストとして読み込み
  const text = await readFileAsText(file, 'Shift-JIS');

  // STEP 2: 前処理：不完全なシングルクォートを削除
  const cleanedText = preprocessCSVText(text);

  // STEP 3: Papa Parseでパース
  return new Promise((resolve, reject) => {
    const config = {
      delimiter: ',',
      newline: '\r\n',
      quoteChar: '"',        // ダブルクォート（シングルクォートは前処理で削除済み）
      escapeChar: '"',
      header: false,
      // ...
    };

    // 前処理済みテキストをパース
    Papa.parse(cleanedText, config);
  });
}

/**
 * CSVテキストの前処理：不完全なシングルクォートを削除
 */
function preprocessCSVText(text) {
  if (!text) return '';

  // すべてのシングルクォート（'）を削除
  // 理由：実際のCSVでは不完全なクォート（開始なし・終了のみ）が存在し、
  //       Papa Parseが誤ってフィールドを結合してしまうため
  let cleaned = text.replace(/'/g, '');

  return cleaned;
}
```

#### standalone版: `app.js`

```javascript
// Shift-JISからUnicodeに変換
const text = Encoding.codeToString(unicodeArray);

// 前処理：不完全なシングルクォートを削除
const cleanedText = text.replace(/'/g, '');
console.log('クォート削除後のテキスト（最初の100文字）:', cleanedText.substring(0, 100));

// Papa Parseで解析
Papa.parse(cleanedText, {
    header: true,
    skipEmptyLines: true,
    delimiter: ',',
    quoteChar: '"',        // ダブルクォート（シングルクォートは前処理で削除済み）
    escapeChar: '"',
    // ...
});
```

---

## 処理フロー

### Before（修正前）

```
CSVファイル（Shift-JIS）
  ↓
エンコーディング変換（Shift-JIS → UTF-8）
  ↓
Papa Parse（quoteChar: "'"）
  - シングルクォートをクォート文字として認識
  - 不完全なクォートでフィールドが結合される
  - 列数が68-69列になる（70列期待）
  ↓
❌ 列ずれが発生
```

### After（修正後）

```
CSVファイル（Shift-JIS）
  ↓
エンコーディング変換（Shift-JIS → UTF-8）
  ↓
【前処理】シングルクォート削除
  text.replace(/'/g, '')
  ↓
Papa Parse（quoteChar: "\""）
  - シングルクォートは通常の文字として処理（すでに削除済み）
  - フィールドが正しく分割される
  - 列数が70列になる
  ↓
✅ 列ずれなし
```

---

## テストケース

### 入力CSV（実際のデータ）

```csv
R1,1,'154848',1,1,1,'     1',1200,'      3500',佐藤 花子',サトウ ハナコ',昭和35年5月10日',' 65','女',...,'2025/02(3)',0412901',...
```

### 期待される結果

| 列番号 | フィールド | 値（前処理前） | クォート削除後 |
|-------|----------|---------------|--------------|
| 3 | 薬局コード | `'154848'` | `154848` |
| 10 | 患者氏名 | `佐藤 花子'` | `佐藤 花子` |
| 11 | 患者カナ | `サトウ ハナコ'` | `サトウ ハナコ` |
| 12 | 生年月日 | `昭和35年5月10日'` | `昭和35年5月10日` |
| 57 | 診療年月日（表示用） | `'2025/02(3)'` | `2025/02(3)` |
| 58 | 受給者番号 | `0412901'` | `0412901` |

### パース結果の検証

```javascript
// 列数チェック
if (cleanedFields.length < 70) {
  console.warn(`警告: 行 ${rowNumber} のフィールド数が不足（${cleanedFields.length}列）`);
}
```

修正後は警告が出なくなります。

---

## 影響範囲

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| **webapp-version/src/js/csv-parser.js** | `parseCSVFile()`に前処理追加、`preprocessCSVText()`関数追加、`getTreatmentDate()`を列57に変更 |
| **standalone-app/app.js** | CSVパース前にクォート削除処理追加 |

### 影響を受ける処理

1. **CSVパース** - すべての行で列数が正しく70列になる
2. **データマッピング** - `CSVRecord.getField()`で正しい列番号からデータを取得
3. **Excel生成** - 正しい列のデータがExcelに書き込まれる

---

## 副次的な効果

### ✅ メリット

1. **列数が安定**: すべての行が70列になる
2. **パースエラーが減少**: Papa Parseのクォート処理エラーがなくなる
3. **データ整合性向上**: 正しい列からデータを取得できる
4. **デバッグが容易**: 列番号が固定されるため、問題の特定が簡単

### ⚠️ 注意点

1. **正規のシングルクォートも削除される**
   - 例: `山田's Pharmacy` → `山adas Pharmacy`
   - しかし、レセプトCSVにはこのようなデータは含まれないため問題なし

2. **文字列内のシングルクォートも削除される**
   - 例: `患者コメント: '重要'` → `患者コメント: 重要`
   - これも実際のCSVには含まれないため問題なし

---

## 動作確認方法

### 1. ブラウザ開発者ツールで確認

1. Webアプリを起動
2. F12で開発者ツールを開く
3. Consoleタブを開く
4. CSVファイルをアップロード
5. ログ確認:
   ```
   クォート削除後のテキスト（最初の100文字）: R1,1,154848,1,1,1,     1,1200,      3500,佐藤 花子,サトウ ハナコ,...
   CSV解析完了: 17 件
   ```

### 2. 列数確認

```javascript
// Consoleで実行
console.log(currentFilteredPatients.target[0]);
// fields配列の長さを確認
console.log(currentFilteredPatients.target[0].fields.length); // 70と表示されるべき
```

### 3. Excel生成確認

1. Excel生成ボタンをクリック
2. ダウンロードされたExcelファイルを開く
3. 各列のデータが正しく配置されているか確認:
   - C列: 医療機関コード（8桁）
   - F列: 受給者番号（シングルクォートなし）
   - G列: 患者氏名（シングルクォートなし）

---

## まとめ

### 修正前の問題

❌ シングルクォートが原因で列がずれる
❌ Papa Parseが誤ってフィールドを結合
❌ 列数が68-69列になる（70列期待）
❌ データマッピングがずれてエラー

### 修正後

✅ 前処理でシングルクォートを完全削除
✅ Papa Parseが正しくフィールドを分割
✅ 列数が常に70列
✅ データマッピングが正確
✅ Excel生成が正しく動作

---

**Document Version**: 1.0
**Last Updated**: 2025-01-15
**Author**: 関根 (sekine53629)
