# 生活保護調剤券請求書作成システム

[![Version](https://img.shields.io/badge/version-2.0.0-blue.svg)](https://github.com)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

## 📋 概要

調剤薬局における生活保護（公費12）調剤券の請求業務を**完全自動化**するWebアプリケーション。

CSVファイルをアップロードするだけで、旭川市への請求書（Excel）を自動生成します。

---

## ✨ 主な特徴

### 🚀 時間削減95%
- **従来**: 月間3-8時間の手作業
- **本システム**: 月間10-15分（自動処理）

### 🎯 ゼロ入力・ゼロミス
- データ入力不要（CSVアップロードのみ）
- ヒューマンエラー完全排除
- 請求差戻しリスクゼロ

### 📊 インテリジェント・フィルタリング
- 旭川市判定（保険者番号 + 住所）
- 自動重複除外（2回目請求）
- 他公費併用の自動検出・警告

### 🔒 プライバシー保護
- クライアントサイド完結
- 患者データは外部送信なし
- ブラウザ内のみで処理

---

## 🗂️ プロジェクト構成

このリポジトリには**2つのバージョン**があります：

### 1. 📦 **スタンドアロン版** (`standalone-app/`)

**特徴**:
- ✅ インストール不要
- ✅ ダブルクリックで起動
- ✅ HTTPサーバー不要（`file://`で動作）
- ✅ CDN経由でライブラリ読み込み

**適用シーン**:
- 個人薬局
- 簡易導入
- テスト・評価

**使い方**:
```bash
standalone-app/index.html をダブルクリック
```

👉 [スタンドアロン版README](standalone-app/README.md)

---

### 2. 🌐 **Webアプリ版** (`webapp-version/`)

**特徴**:
- ✅ 高機能版
- ✅ 組み込みテンプレート
- ✅ IndexedDBアーカイブ
- ✅ モジュール化設計

**必要環境**:
- HTTPサーバー（Python, Node.js等）

**使い方**:
```bash
cd webapp-version
python -m http.server 8000
# http://localhost:8000 でアクセス
```

👉 [Webアプリ版README](webapp-version/README.md)

---

## 🆚 バージョン比較

| 項目 | スタンドアロン版 | Webアプリ版 |
|-----|----------------|------------|
| **インストール** | 不要 | Python等必要 |
| **起動方法** | ダブルクリック | HTTPサーバー |
| **ライブラリ** | CDN読み込み | ローカルモジュール |
| **アーカイブ** | localStorage（簡易） | IndexedDB（高機能） |
| **テンプレート** | 動的ダウンロード | 組み込み |
| **オフライン** | △（初回DL必要） | ◎（完全オフライン） |
| **適用** | 個人利用 | 組織導入 |

**推奨**:
- 初めての方・簡易導入 → **スタンドアロン版**
- 組織導入・高度な機能 → **Webアプリ版**

---

## 🚀 クイックスタート

### スタンドアロン版（推奨：初めての方）

1. **ダウンロード**
   ```bash
   git clone https://github.com/sekine53629/welfare-dispensing-invoice-generator.git
   cd welfare-dispensing-invoice-generator/standalone-app
   ```

2. **起動**
   ```
   index.html をダブルクリック
   ```

3. **使用**
   - CSVファイルをドラッグ&ドロップ
   - 請求回数を選択（1回目 or 2回目）
   - Excelダウンロード

### Webアプリ版（組織導入）

1. **ダウンロード**
   ```bash
   git clone https://github.com/sekine53629/welfare-dispensing-invoice-generator.git
   cd welfare-dispensing-invoice-generator/webapp-version
   ```

2. **HTTPサーバー起動**
   ```bash
   python -m http.server 8000
   ```

3. **ブラウザでアクセス**
   ```
   http://localhost:8000
   ```

4. **設定**
   - 設定タブで薬局名・医療機関コードを登録
   - 請求書作成タブでCSVアップロード

---

## 📊 機能一覧

### 共通機能

| 機能 | 説明 |
|-----|------|
| CSVアップロード | ドラッグ&ドロップ対応、Shift-JIS/UTF-8自動判定 |
| 旭川市フィルタリング | 保険者番号（12016010, 12012019）または住所で判定 |
| 重複除外 | 受給者番号+調剤日+氏名で自動除外（2回目請求） |
| 他公費検出 | 21/15/16/54を自動検出、黄色背景で警告 |
| チェックボックス | 個別に患者を除外可能（デフォルト全選択） |
| Excel生成 | 旭川市公式テンプレート形式で自動生成 |
| 請求先リンク | 電子請求フォーム、ログイン、案内ページへ直接アクセス |

### Webアプリ版のみ

| 機能 | 説明 |
|-----|------|
| アーカイブ管理 | 過去の請求書をIndexedDBに保存、再ダウンロード可能 |
| 設定管理 | 薬局名・医療機関コードをlocalStorageに保存 |
| 組み込みテンプレート | アプリ起動時に自動読み込み、選択不要 |
| 統計ダッシュボード | 月別フィルタ、処理履歴表示 |

---

## 📚 ドキュメント

### プロジェクト全体
- [コンセプトデザイン](docs/CONCEPT_DESIGN.md) - システムの全体像・価値提案
- [詳細仕様書](docs/SPECIFICATION.md) - 技術仕様・テストケース

### データ仕様・技術詳細
- [データ仕様](docs/data-specification.md) - CSV構造、フィルタリングロジック
- [公費詳細](docs/kohi-details.md) - 公費番号、優先順位、請求フロー
- [チェックボックス仕様](docs/checkbox-feature-spec.md) - チェックボックス機能の詳細
- **[本番CSV仕様](docs/PRODUCTION-CSV-SPECIFICATION.md)** - VBA解析に基づく正確な列マッピング
- **[CSV列ずれ修正](docs/csv-column-alignment-fix.md)** - シングルクォート問題の解決方法
- [Excelバリデーション仕様](docs/excel-validation-spec.md) - Excel生成時のデータ検証
- [CSVクォート修正](docs/csv-quote-fix.md) - クォート削除処理の詳細

### バージョン別
- [スタンドアロン版README](standalone-app/README.md)
- [Webアプリ版README](webapp-version/README.md)
- [テンプレート組み込み](webapp-version/TEMPLATE_EMBEDDED.md)

---

## 🛠️ 技術スタック

### フロントエンド
- **Vanilla JavaScript (ES6+)** - フレームワーク不要、軽量・高速
- **CSS3 (Flexbox/Grid)** - レスポンシブデザイン
- **HTML5** - セマンティックマークアップ

### ライブラリ
- **Papa Parse 5.4.1** - CSV解析（Shift-JIS対応）
- **ExcelJS 4.4.0** - Excel生成（クライアントサイド）
- **localforage 1.10.0** - IndexedDB wrapper（Webアプリ版のみ）

### ストレージ
- **localStorage** - 設定保存
- **IndexedDB** - アーカイブ保存（Webアプリ版のみ）

---

## 🖥️ 動作環境

### 対応ブラウザ
- Google Chrome 100以上（推奨）
- Microsoft Edge 100以上
- Firefox 100以上
- Safari 15以上

### 非対応
- Internet Explorer（すべてのバージョン）
- 古いブラウザ（ES6非対応）

---

## 📖 使用方法

### 基本フロー

```
1. CSVファイルをアップロード
   ↓
2. 請求回数を選択（1回目 or 2回目）
   ↓
3. 自動フィルタリング
   - 旭川市のみ抽出
   - 重複除外（2回目のみ）
   - 他公費併用検出
   ↓
4. 患者リスト確認
   - 必要に応じてチェックを外す
   ↓
5. Excelダウンロード
   ↓
6. 電子請求フォームでアップロード
```

**所要時間**: 約1-2分

---

## 🐛 トラブルシューティング

### よくある質問

#### Q1: テンプレートダウンロードエラー
**A**: インターネット接続を確認してください。スタンドアロン版は初回Excel生成時にテンプレートをダウンロードします。

#### Q2: 2回目請求で重複除外されない
**A**: 1回目請求を実行してから2回目請求を行ってください。処理済みキーがlocalStorageに保存されます。

#### Q3: CSVアップロードエラー
**A**: CSV形式とエンコーディングを確認してください：
- Shift-JIS または UTF-8
- カンマ区切り
- ヘッダー行あり

#### Q4: Excelが開けない
**A**: Excel 2016以降で開いてください。古いバージョンでは開けない可能性があります。

---

## 🔐 セキュリティ

### データ保護
- ✅ すべての処理がブラウザ内で完結
- ✅ 患者データは外部に送信されません
- ✅ ネットワーク送信なし（テンプレートDL除く）

### ストレージ
- localStorage: 設定、処理済みキー（暗号化なし）
- IndexedDB: Excelファイル（Blob、暗号化なし）

### 推奨事項
- 共有PCでは使用後にブラウザキャッシュをクリア
- 定期的にlocalStorage/IndexedDBをクリア

---

## 🔄 更新履歴

### v2.1.0（2026-01-15）
- 🐛 **CSV列ずれ問題修正** - シングルクォート前処理による完全解決
- 🐛 **診療年月日列番号修正** - VBA実装に基づき列57→56に変更
- ✨ **医療機関コード自動取得** - CSV列65から自動読み込み（先頭01削除対応）
- ✨ **YYYYMMDD形式対応** - `parseYYYYMMDD()`関数追加
- ✨ **複数来局日統合** - 同一患者の複数来局を`2025/2(7,10,25)`形式で表示
- ✨ **公費フラグ自動検出** - 自立支援（21/15/16）、重障（54）の自動判定
- 📚 **本番CSV仕様書作成** - VBAコード解析による詳細ドキュメント化
- 🔧 **standalone版`removeLeading01`関数追加** - webapp版との完全同期

### v2.0.0（2025-02-15）
- ✨ スタンドアロン版追加
- ✨ Webアプリ版リニューアル
- ✨ 組み込みテンプレート対応
- ✨ 1画面UI実装
- ✨ チェックボックス機能追加
- ✨ 請求先リンク統合

### v1.0.0（2025-01-XX）
- 🎉 初回リリース（VBA版）

---

## 📞 サポート

### 開発者
**関根 (sekine53629)**
- GitHub: https://github.com/sekine53629/welfare-dispensing-invoice-generator
- Email: sekine53629@example.com

### 旭川市への請求に関するお問い合わせ
**旭川市福祉保険部 生活支援課 医療介護係**
- 電話: 0166-25-9121
- 住所: 〒070-8525 北海道旭川市7条通9丁目48番地 総合庁舎5階

---

## 📄 ライセンス

MIT License

このソフトウェアは個人・商用利用ともに無料でご利用いただけます。

---

## 🙏 謝辞

- 旭川市福祉保険部 生活支援課 - 公式テンプレート提供
- Papa Parse - CSV解析ライブラリ
- ExcelJS - Excel生成ライブラリ

---

## 🎯 今後の展望

### フェーズ2: 利便性向上（2025年Q2）
- [ ] 検索・ソート機能強化
- [ ] 統計ダッシュボード
- [ ] アーカイブのエクスポート/インポート

### フェーズ3: 多機能化（2025年Q3-Q4）
- [ ] 複数市町村対応
- [ ] 公費併用時の請求額自動計算
- [ ] PDF出力機能

### フェーズ4: 高度化（2026年～）
- [ ] 機械学習による請求漏れ検出
- [ ] クラウド同期オプション
- [ ] PWA化（モバイルアプリ）

---

## 🎉 まとめ

このシステムは、**調剤薬局の請求業務を95%削減**することを目的とした、完全自動化ツールです。

### 3つの柱
1. **ゼロ入力・ゼロミス** - 完全自動化
2. **インストール不要** - ブラウザで完結
3. **プライバシー保護** - データ外部送信なし

**「3クリックで請求完了。薬局業務を、もっとシンプルに。」**

薬局スタッフの皆様の業務効率化にお役立てください！ 🚀
