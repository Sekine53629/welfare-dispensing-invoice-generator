# 生活保護調剤券請求書作成システム

[![Version](https://img.shields.io/badge/version-2.4.0-blue.svg)](https://github.com)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

## 📋 概要

調剤薬局における生活保護（公費12）調剤券の請求業務を**完全自動化**するWebアプリケーション。

CSVファイルをアップロードするだけで、旭川市への請求書（Excel）を自動生成します。

---

## ✨ 主な特徴

### 🚀 時間削減95%
- **従来**: 月間3-8時間の手作業
- **本システム**: 月間10-15分（自動処理）

### 🎯 ゼロ入力・ゼロミス
- データ入力不要（CSVアップロードのみ）
- ヒューマンエラー完全排除
- 請求差戻しリスクゼロ

### 📊 インテリジェント・フィルタリング
- 旭川市判定（保険者番号 + 住所）
- 自動重複除外（2回目請求）
- 他公費併用の自動検出・警告

### 🔒 プライバシー保護
- クライアントサイド完結
- 患者データは外部送信なし
- ブラウザ内のみで処理

---

## 🗂️ プロジェクト構成

このリポジトリには**2つのバージョン**があります：

### 1. 📦 **スタンドアロン版** (`standalone-app/`)

**特徴**:
- ✅ インストール不要
- ✅ ダブルクリックで起動
- ✅ HTTPサーバー不要（`file://`で動作）
- ✅ CDN経由でライブラリ読み込み

**適用シーン**:
- 個人薬局
- 簡易導入
- テスト・評価

**使い方**:
```bash
standalone-app/index.html をダブルクリック
```

👉 [スタンドアロン版README](standalone-app/README.md)

---

### 2. 🌐 **Webアプリ版** (`webapp-version/`)

**特徴**:
- ✅ 高機能版
- ✅ 組み込みテンプレート
- ✅ IndexedDBアーカイブ
- ✅ モジュール化設計

**必要環境**:
- HTTPサーバー（Python, Node.js等）

**使い方**:
```bash
cd webapp-version
python -m http.server 8000
# http://localhost:8000 でアクセス
```

👉 [Webアプリ版README](webapp-version/README.md)

---

## 🆚 バージョン比較

| 項目 | スタンドアロン版 | Webアプリ版 |
|-----|----------------|------------|
| **インストール** | 不要 | Python等必要 |
| **起動方法** | ダブルクリック | HTTPサーバー |
| **ライブラリ** | CDN読み込み | ローカルモジュール |
| **アーカイブ** | localStorage（簡易） | IndexedDB（高機能） |
| **テンプレート** | 動的ダウンロード | 組み込み |
| **オフライン** | △（初回DL必要） | ◎（完全オフライン） |
| **適用** | 個人利用 | 組織導入 |

**推奨**:
- 初めての方・簡易導入 → **スタンドアロン版**
- 組織導入・高度な機能 → **Webアプリ版**

---

## 🔤 文字エンコーディング対応 (v2.3.12)

レセコンから出力されるCSVファイルのエンコーディングに対応：

| モード | 説明 | 用途 |
|--------|------|------|
| **ANSI優先** | Shift-JIS/CP932として強制処理 | 2026年1月～の本番データ |
| **UTF-8優先** | UTF-8を先に試行 | 従来データ |
| **自動検出** | ライブラリによる自動判定 | 混在環境 |

### 背景

- **ANSI**: Windows日本語環境のデフォルト（= Shift-JIS/CP932、BOMなし）
- **UTF-8 BOM付き**: ファイル先頭に `EF BB BF` のマーカーあり
- レセコンの出力形式が時期により異なる場合があるため、手動切り替え機能を実装

---

## 🚀 クイックスタート

### スタンドアロン版（推奨：初めての方）

1. **ダウンロード**
   ```bash
   git clone https://github.com/sekine53629/welfare-dispensing-invoice-generator.git
   cd welfare-dispensing-invoice-generator/standalone-app
   ```

2. **起動**
   ```
   index.html をダブルクリック
   ```

3. **使用**
   - CSVファイルをドラッグ&ドロップ
   - 請求回数を選択（1回目 or 2回目）
   - Excelダウンロード

### Webアプリ版（組織導入）

1. **ダウンロード**
   ```bash
   git clone https://github.com/sekine53629/welfare-dispensing-invoice-generator.git
   cd welfare-dispensing-invoice-generator/webapp-version
   ```

2. **HTTPサーバー起動**
   ```bash
   python -m http.server 8000
   ```

3. **ブラウザでアクセス**
   ```
   http://localhost:8000
   ```

4. **設定**
   - 設定タブで薬局名・医療機関コードを登録
   - 請求書作成タブでCSVアップロード

---

## 📊 機能一覧

### 共通機能

| 機能 | 説明 |
|-----|------|
| CSVアップロード | ドラッグ&ドロップ対応、Shift-JIS/UTF-8自動判定 |
| 旭川市フィルタリング | 保険者番号（12016010, 12012019）または住所で判定 |
| 重複除外 | 受給者番号+調剤日+氏名で自動除外（2回目請求） |
| 他公費検出 | 21/15/16/54を自動検出、黄色背景で警告 |
| チェックボックス | 個別に患者を除外可能（デフォルト全選択） |
| Excel生成 | 旭川市公式テンプレート形式で自動生成 |
| 請求先リンク | 電子請求フォーム、ログイン、案内ページへ直接アクセス |

### Webアプリ版のみ

| 機能 | 説明 |
|-----|------|
| アーカイブ管理 | 過去の請求書をIndexedDBに保存、再ダウンロード可能 |
| 設定管理 | 薬局名・医療機関コードをlocalStorageに保存 |
| 組み込みテンプレート | アプリ起動時に自動読み込み、選択不要 |
| 統計ダッシュボード | 月別フィルタ、処理履歴表示 |

---

## 📚 ドキュメント

### プロジェクト全体
- [コンセプトデザイン](docs/CONCEPT_DESIGN.md) - システムの全体像・価値提案
- [詳細仕様書](docs/SPECIFICATION.md) - 技術仕様・テストケース

### データ仕様・技術詳細
- [データ仕様](docs/data-specification.md) - CSV構造、フィルタリングロジック
- [公費詳細](docs/kohi-details.md) - 公費番号、優先順位、請求フロー
- [チェックボックス仕様](docs/checkbox-feature-spec.md) - チェックボックス機能の詳細
- **[本番CSV仕様](docs/PRODUCTION-CSV-SPECIFICATION.md)** - VBA解析に基づく正確な列マッピング
- **[CSV列ずれ修正](docs/csv-column-alignment-fix.md)** - シングルクォート問題の解決方法
- [Excelバリデーション仕様](docs/excel-validation-spec.md) - Excel生成時のデータ検証
- [CSVクォート修正](docs/csv-quote-fix.md) - クォート削除処理の詳細

### バージョン別
- [スタンドアロン版README](standalone-app/README.md)
- [Webアプリ版README](webapp-version/README.md)
- [テンプレート組み込み](webapp-version/TEMPLATE_EMBEDDED.md)

---

## 🛠️ 技術スタック

### フロントエンド
- **Vanilla JavaScript (ES6+)** - フレームワーク不要、軽量・高速
- **CSS3 (Flexbox/Grid)** - レスポンシブデザイン
- **HTML5** - セマンティックマークアップ

### ライブラリ
- **Papa Parse 5.4.1** - CSV解析（Shift-JIS対応）
- **ExcelJS 4.4.0** - Excel生成（クライアントサイド）
- **localforage 1.10.0** - IndexedDB wrapper（Webアプリ版のみ）

### ストレージ
- **localStorage** - 設定保存
- **IndexedDB** - アーカイブ保存（Webアプリ版のみ）

---

## 🖥️ 動作環境

### 対応ブラウザ
- Google Chrome 100以上（推奨）
- Microsoft Edge 100以上
- Firefox 100以上
- Safari 15以上

### 非対応
- Internet Explorer（すべてのバージョン）
- 古いブラウザ（ES6非対応）

---

## 📖 使用方法

### 基本フロー（v2.4.0～）

```
1. Pharnesで調剤券CSVを出力
   - 6.患者検索から期間選択
   - 出力形式をCSVに変更
   - ファイル名を編集して出力
   ↓
2. ツールでExcelファイル作成
   - CSVファイルをアップロード
   - 請求回数を選択（1回目 or 2回目）
   - 自動フィルタリング（旭川市抽出・重複除外）
   - Excelダウンロード
   ↓
3. 電子請求フォームで提出
   - メイン画面のフォームリンクを押下
   - 必要事項を入力
   - Excelファイルを添付
   - 送信確認画面で内容確認
   - データを送信
   - 他公費併用検出
   ↓
4. 患者リスト確認
   - 必要に応じてチェックを外す
   ↓
5. Excelダウンロード
   ↓
```

**所要時間**: 約3-5分（CSV出力～フォーム提出まで）

---

## 🐛 トラブルシューティング

### よくある質問

#### Q1: テンプレートダウンロードエラー
**A**: インターネット接続を確認してください。スタンドアロン版は初回Excel生成時にテンプレートをダウンロードします。

#### Q2: 2回目請求で重複除外されない
**A**: 1回目請求を実行してから2回目請求を行ってください。処理済みキーがlocalStorageに保存されます。

#### Q3: CSVアップロードエラー
**A**: CSV形式とエンコーディングを確認してください：
- Shift-JIS または UTF-8
- カンマ区切り
- ヘッダー行あり（HR形式の場合は不要）

**CSV解析仕様（RFC 4180準拠）**:
1. **カンマ（`,`）**: フィールド区切り文字として処理
2. **シングルクォート（`'`）**: フィールドの囲み文字として認識
   - `'` を検知した場合、次の `'` までカンマを文字として処理
   - 例: `'2025/12(1,9,25)'` → 1つのフィールドとして処理
3. **改行コード**: レコード（行）の区切りとして処理
4. **HR形式（マルチレコード形式）対応**:
   - 1列目が `H` の行: ヘッダー行（スキップ）
   - 1列目が `R1` の行: 患者データ行（抽出対象）
   - 調剤券データには現在、HとR1の2種類のみ存在

#### Q4: Excelが開けない
**A**: Excel 2016以降で開いてください。古いバージョンでは開けない可能性があります。

---

## 🔐 セキュリティ

### データ保護
- ✅ すべての処理がブラウザ内で完結
- ✅ 患者データは外部に送信されません
- ✅ ネットワーク送信なし（テンプレートDL除く）

### ストレージ
- localStorage: 設定、処理済みキー（暗号化なし）
- IndexedDB: Excelファイル（Blob、暗号化なし）

### 推奨事項
- 共有PCでは使用後にブラウザキャッシュをクリア
- 定期的にlocalStorage/IndexedDBをクリア

---

## 🔄 更新履歴

### v2.4.0（2026-01-22）
- 📊 **Excel出力仕様変更（市役所要望対応）**
  - C列・E列: ラベル「コード」に変更、int型8桁固定
  - F列: int型7桁固定
  - H列: ラベル「氏名カナ」に変更
  - I列: 日付型（シリアル値）、yyyy/m/d形式
  - J列: ラベル「調剤年月日」、日付型、月初来局日のみ出力
  - K列: ラベル「社保」に変更
  - M列: ラベル「難病」に変更
- 🔄 **月跨ぎデータ処理改善** - 同一患者で月を跨ぐ場合は複数行に分割、今月分が先・前月分が後
- 🐛 **J列参照元変更** - CSV 56列目（最終来局日）→ 55列目（月初来局日）
- 📖 **マニュアル大幅改定**
  - Pharnesからの調剤券CSV出力手順を追加（STEP 0-1～0-5）
  - Excel出力後の電子請求フォーム提出手順を追加（STEP 5～9）
  - 通しでの作業フロー（CSV作成→Excel作成→フォーム提出）を網羅的に記載
  - 目次に各セクションへのアンカーリンク追加

### v2.3.12（2026-01-20）
- 🔤 **ANSIエンコーディング優先モード実装** - 2026年1月から本番データがANSI（BOMなしShift-JIS）形式に変更されたことに対応
- 🎛️ **エンコーディング選択UI追加** - ANSI優先/UTF-8優先/自動検出の3モードを手動切り替え可能
- 💾 **設定永続化** - エンコーディングモードをlocalStorageに保存、次回起動時も維持
- 🐛 **Encoding.detect()誤検出修正** - ANSIファイルが「UNICODE」と誤検出される問題に対応
- 🔧 **強制Shift-JIS処理** - ANSI優先モードでは検出結果を無視し、強制的にShift-JISとして処理

### v2.3.11（2026-01-18）
- 🔤 **CSV文字化け（□文字）問題の解決** - UTF-8/Shift-JIS の自動判定機能を実装
- 📊 **複数エンコーディング試行機能** - 優先順位: UTF-8 (BOM付き) → UTF-8 (BOMなし) → Shift-JIS
- 🔍 **文字化けチェック機能** - □や�の検出による自動フォールバック処理
- 🐛 **BOM検出機能追加** - UTF-8 with BOM対応
- 📋 **デバッグ強化** - 検出されたエンコーディングをコンソールに詳細表示、UIに表示

### v2.3.10（2026-01-18）
- ⚙️ **前月分データのチェックボックスをデフォルトオフに変更** - 99%のデータが請求済みと想定
- 🎯 **UX改善** - ユーザーが明示的に未請求データを選択する設計に変更
- 📊 **統計情報初期化** - 請求対象が初期状態は0件表示

### v2.3.9（2026-01-18）
- 📅 **前月分CSV追加機能の実装** - 月遅れ請求対応、当月分データ読み込み後に前月分データを追加可能
- 🔄 **重複チェック対象外処理** - 前月分データは重複チェックの対象外として処理
- 🎨 **UI配置改善** - data-view内に「前月分CSVファイルを選択」ボタンを配置

### v2.3.8（2026-01-18）
- 🔧 **前月分データ処理ロジック修正** - 当月分と同じCSV解析処理を使用
- 🎯 **旭川市データ抽出フィルタの実装** - 前月分データにも適用
- 📊 **ステータス表示とエラーハンドリングの改善**

### v2.3.7（2026-01-18）
- 🔧 **月遅れ請求ロジック修正** - 重複チェックを削除、全データを請求対象に
- 📋 **月遅れバッジ追加** - 「月遅れ請求」バッジで視覚的に区別
- 📖 **マニュアル改訂** - 月遅れ請求の正しい業務フローを反映
- 🎨 **ヘッダーにマニュアルボタン追加** - 相対パスで別タブ表示
- 📄 **印刷用CSS強化** - A4改ページ制御、プライバシー注釈の赤背景表示

### v2.3.6（2026-01-18）
- ✅ **rows配列追加でテーブル作成完全解決** - `columns` + `rows`を明示的に定義
- 🔧 **データ行の明示的指定** - ExcelJSが要求するrows定義を追加してテーブル生成成功
- 📊 **VBA完全互換確定** - テーブル「調剤請求」がListObjects経由で参照可能

### v2.3.5（2026-01-18）
- ⚠️ **カラム定義追加試行** - `columns`配列を定義したが"Table must have row definitions"エラー
- 🔍 **テンプレート解析完了** - テンプレートにテーブル構造が含まれていないことを確認

### v2.3.4（2026-01-18）
- ⚠️ **headerRow=false試行** - "Table must have column definitions"エラーが発生

### v2.3.3（2026-01-18）
- 🐛 **テーブル生成順序修正** - データ書き込み→テーブル化の正しい順序に変更（※v2.3.4で再修正）
- 📊 **テンプレート競合解消** - 既存ヘッダー行とテーブル定義の衝突を回避
- ✅ **XML整合性確保** - 書き込み→再読み込み→再書き込みでテーブルXML検証

### v2.3.2（2026-01-18）
- 🐛 **テーブル生成修正** - データ書き込み前にテーブル定義を作成（※v2.3.3で順序再修正）
- 📊 **テーブルスタイル変更** - TableStyleLight9に変更し、Excel破損を回避
- 🎨 **バージョン表示追加** - UI上部にv2.3.2を表示、ブラウザキャッシュ対策

### v2.3.1（2026-01-18）
- 🐛 **Excelファイルエラー修正** - テーブル機能を廃止、オートフィルター+縞模様スタイルに変更（※v2.3.2で再度テーブル機能実装）
- 📊 **視認性向上** - データ行に青系縞模様を適用、フィルター機能も維持

### v2.3.0（2026-01-18）
- 📅 **前月分データ追加機能** - 月遅れ請求のための前月分CSV読み込み機能を実装
- 🔄 **重複チェック強化** - 前月分データと当月データの重複チェック
- ✅ **未請求分自動選択** - 前月分データは未請求分のみチェックON、重複分はOFF
- 📊 **別表表示** - 前月分データを別セクションに表示、折りたたみ可能
- 🔢 **統合Excel生成** - 当月データと前月分データを統合してExcel出力

### v2.2.0（2026-01-17）
- 📊 **Excelテーブル機能実装** - 生成されるExcelファイルにテーブル機能（`調剤請求`）を追加
- 🎨 **テーブルスタイル適用** - フィルター機能、縞模様表示で視認性向上
- ⚠️ **テーブル名固定** - `調剤請求` として固定（集約処理で必須）

### v2.1.5（2026-01-17）
- 📋 **重複データ表示改善** - 全データをリスト表示、重複データは初期状態でチェックオフ
- ✨ **統計ラベル改善** - 「全レコード数」「旭川市抽出」「うち重複」で明確化
- 🎯 **手動選択可能** - 重複データも必要に応じてチェックONで処理可能
- 📊 **透明性向上** - 全行数が読み込まれているか確認可能

### v2.1.4（2026-01-17）
- 🔒 **重複チェックキー改善** - 患者氏名ハッシュ化によるプライバシー保護
- ✨ **年月単位の重複管理** - 年月+患者氏名ハッシュ+医療機関コードで正確な重複検出
- 🐛 **世帯単位受給者番号対応** - 受給者番号の世帯単位問題を回避
- 📊 **同一患者・複数医療機関対応** - 同日受診でも医療機関別に正しく請求

### v2.1.3（2026-01-17）
- ⚡ **DOM操作高速化** - DocumentFragmentによる一括DOM操作で大量データ処理を改善
- 🐛 **undefined統合チェック** - 受給者番号・患者名が空の患者を統合処理から除外
- ✨ **医療機関コード処理改善** - 下8桁抽出、種別コード検証（1:病院/3:歯科/4:薬局）
- 🛡️ **localStorage容量エラーハンドリング** - 容量上限時に自動的に古いデータを削除
- ⚡ **半角カナ変換の正規表現化** - 大量データでの処理速度向上
- 🔒 **型安全性改善** - String()正規化による型エラー防止

### v2.1.2（2026-01-17）
- 🐛 **シングルクォート処理修正** - Papa Parse quoteChar設定でカンマ入り日付フィールド対応
- 🐛 **日付データスペース削除** - 生年月日・診療年月日から全角半角スペース除去
- 🐛 **半角カナ完全対応** - 濁点・半濁点付きカナの完全変換マップ実装

### v2.1.1（2026-01-15）
- 🐛 **HR形式CSV対応** - マルチレコードフォーマット（R1レコード抽出）
- 🐛 **K・L・M列修正** - K:主保険、L:自立支援、M:重障の正しい配置
- 🐛 **Papa Parse設定修正** - header:falseでエラー警告解消
- ✨ **主保険判定機能** - 列17の保険区分から社保・国保を判定

### v2.1.0（2026-01-15）
- 🐛 **CSV列ずれ問題修正** - シングルクォート前処理による完全解決
- 🐛 **診療年月日列番号修正** - VBA実装に基づき列57→56に変更
- ✨ **医療機関コード自動取得** - CSV列65から自動読み込み（先頭01削除対応）
- ✨ **YYYYMMDD形式対応** - `parseYYYYMMDD()`関数追加
- ✨ **複数来局日統合** - 同一患者の複数来局を`2025/2(7,10,25)`形式で表示
- ✨ **公費フラグ自動検出** - 自立支援（21/15/16）、重障（54）の自動判定
- 📚 **本番CSV仕様書作成** - VBAコード解析による詳細ドキュメント化
- 🔧 **standalone版`removeLeading01`関数追加** - webapp版との完全同期

### v2.0.0（2025-02-15）
- ✨ スタンドアロン版追加
- ✨ Webアプリ版リニューアル
- ✨ 組み込みテンプレート対応
- ✨ 1画面UI実装
- ✨ チェックボックス機能追加
- ✨ 請求先リンク統合

### v1.0.0（2025-01-XX）
- 🎉 初回リリース（VBA版）

---

## 📞 サポート

### 開発者
**関根 (sekine53629)**
- GitHub: https://github.com/sekine53629/welfare-dispensing-invoice-generator
- Email: sekine53629@example.com

### 旭川市への請求に関するお問い合わせ
**旭川市福祉保険部 生活支援課 医療介護係**
- 電話: 0166-25-9121
- 住所: 〒070-8525 北海道旭川市7条通9丁目48番地 総合庁舎5階

---

## 📄 ライセンス

MIT License

このソフトウェアは個人・商用利用ともに無料でご利用いただけます。

---

## 🙏 謝辞

- 旭川市福祉保険部 生活支援課 - 公式テンプレート提供
- Papa Parse - CSV解析ライブラリ
- ExcelJS - Excel生成ライブラリ

---

## 🎯 今後の展望

### フェーズ2: 利便性向上（2025年Q2）
- [ ] 検索・ソート機能強化
- [ ] 統計ダッシュボード
- [ ] アーカイブのエクスポート/インポート

### フェーズ3: 多機能化（2025年Q3-Q4）
- [ ] 複数市町村対応
- [ ] 公費併用時の請求額自動計算
- [ ] PDF出力機能

### フェーズ4: 高度化（2026年～）
- [ ] 機械学習による請求漏れ検出
- [ ] クラウド同期オプション
- [ ] PWA化（モバイルアプリ）

---

## 🎉 まとめ

このシステムは、**調剤薬局の請求業務を95%削減**することを目的とした、完全自動化ツールです。

### 3つの柱
1. **ゼロ入力・ゼロミス** - 完全自動化
2. **インストール不要** - ブラウザで完結
3. **プライバシー保護** - データ外部送信なし

**「3クリックで請求完了。薬局業務を、もっとシンプルに。」**

薬局スタッフの皆様の業務効率化にお役立てください！ 🚀
