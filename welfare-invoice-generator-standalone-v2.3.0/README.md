# 生活保護調剤券請求書作成ツール - スタンドアロン版

## 📋 概要

**インストール不要、ブラウザで完結する請求書作成ツール**

CSVファイルをアップロードするだけで、旭川市への生活保護調剤券請求書（Excel）を自動生成します。

---

## ✨ 特徴

### 🚀 インストール不要
- ダブルクリックでHTMLファイルを開くだけ
- Pythonやサーバー環境は不要
- ブラウザだけで動作

### 🔒 プライバシー保護
- すべての処理がブラウザ内で完結
- データは外部に送信されません
- 完全オフライン動作（初回読み込み後）

### ⚡ 高速処理
- 100件のデータを3秒以内に処理
- リアルタイムフィルタリング
- 自動重複除外

### 🎨 シンプルなUI
- 1画面で全操作が完結
- ドラッグ&ドロップ対応
- レスポンシブデザイン（PC・タブレット・スマホ対応）

---

## 🖥️ 動作環境

### 必要なもの
- **モダンブラウザ** (以下のいずれか)
  - Google Chrome 100以上（推奨）
  - Microsoft Edge 100以上
  - Firefox 100以上
  - Safari 15以上

### 不要なもの
- ❌ Python
- ❌ Node.js
- ❌ Webサーバー
- ❌ インストール作業

---

## 🚀 使い方

### 1. ファイルを開く

**方法A: ダブルクリック**
```
standalone-app/index.html をダブルクリック
```

**方法B: ブラウザで開く**
```
ブラウザを起動 → ファイル → ファイルを開く → index.html を選択
```

### 2. CSVファイルをアップロード

1. レセプトデータのCSVファイルを用意
2. ドラッグ&ドロップ または 「ファイルを選択」ボタンをクリック
3. 請求回数を選択（1回目 or 2回目）

### 3. データ確認

自動的に以下の処理が実行されます：
- ✅ 旭川市のデータのみ抽出（保険者番号 or 住所）
- ✅ 重複除外（2回目請求時のみ）
- ✅ 他公費併用の検出（21/15/16/54）

### 4. 除外患者を選択（オプション）

- 他公費で全額カバーされる患者はチェックを外す
- 全選択/全解除も可能

### 5. Excelダウンロード

- 「📥 Excelダウンロード」ボタンをクリック
- 旭川市公式テンプレート形式で自動生成
- ファイル名: `調剤券_旭川市_YYYYMM_薬局名_N回目.xlsx`

### 6. 電子請求

- 生成されたExcelファイルを確認
- 「🔗 請求先リンク」から電子請求フォームへアクセス
- LoGoフォームでアップロード

---

## 📊 機能詳細

### データフィルタリング

#### 旭川市判定
```
優先1: 保険者番号チェック
  - 12016010（旭川市）
  - 12012019（旭川市・後期高齢者）

優先2: 住所チェック（フォールバック）
  - 住所に「旭川市」を含む
```

#### 重複除外（2回目請求）
```
ユニークキー = 受給者番号 + 調剤年月日 + 氏名
```

### 他公費併用検出

以下の公費番号を自動検出し、黄色背景で表示：
| 公費番号 | 名称 | 表示 |
|---------|------|------|
| 21 | 精神通院医療 | 🏷️ 精 |
| 15 | 更生医療 | 🏷️ 更 |
| 16 | 育成医療 | 🏷️ 育 |
| 54 | 難病医療 | 🏷️ 難 |

### Excel出力

**テンプレート**: 旭川市公式（動的ダウンロード）
**書き込み開始**: A6セル
**出力項目**:
- 通番
- 受給者番号
- 氏名
- 生年月日
- 調剤年月日
- 処方箋医療機関名
- 備考

---

## 🔗 外部リンク統合

アプリ内から直接アクセス可能：

| リンク | URL |
|-------|-----|
| 📝 電子請求フォーム | https://logoform.jp/form/iLZf/662007 |
| 🔐 ログイン | https://logoform.jp/login |
| 📄 案内ページ | https://www.city.asahikawa.hokkaido.jp/kurashi/135/189/190/d080493.html |
| 📞 お問い合わせ | 0166-25-9121（クリックで発信） |

---

## ⚙️ 設定

### 初回設定（必須）

1. **設定タブ**を開く
2. **薬局名**を入力（例: さくら薬局）
3. **医療機関コード**を入力（任意、10桁）
4. **テンプレートファイル**を選択
   - 「ファイルを選択」ボタンをクリック
   - `tyouzai_excel_v2.xlsx` を選択
5. **保存**ボタンをクリック

### テンプレートファイルについて

- 初回使用時に必ずテンプレートファイルを選択してください
- ファイル選択後、「選択済: tyouzai_excel_v2.xlsx」と表示されます
- テンプレートファイルは `standalone-app` フォルダ内にあります
- ブラウザを閉じるとリセットされるため、再起動時は再選択が必要です

---

## 🐛 トラブルシューティング

### Q1: ファイルを開いても動作しない

**A**: 以下を確認してください：
- ✅ モダンブラウザを使用しているか
- ✅ JavaScriptが有効になっているか
- ✅ `index.html` と `app.js` が同じフォルダにあるか

### Q2: CSVアップロードでエラーが出る

**A**: CSV形式を確認してください：
- ✅ Shift-JIS または UTF-8 エンコーディング
- ✅ カンマ区切り（CSV形式）
- ✅ ヘッダー行あり

### Q3: 「テンプレートファイルが選択されていません」エラー

**A**: 設定タブでテンプレートファイルを選択してください：
- 設定タブを開く
- テンプレートファイル選択で「ファイルを選択」をクリック
- `tyouzai_excel_v2.xlsx` を選択
- 「選択済: tyouzai_excel_v2.xlsx」と表示されることを確認

### Q4: Excelダウンロードに時間がかかる

**A**: 以下の可能性があります：
- データ件数が多い（100件以上）
- ブラウザの処理速度
- Excel生成処理の負荷

### Q5: 2回目請求で重複除外されない

**A**: ブラウザのローカルストレージを確認：
- 1回目請求時の処理済みキーがlocalStorageに保存されます
- ブラウザのキャッシュをクリアすると消えます

---

## 🔐 セキュリティ・プライバシー

### データの扱い

✅ **安全**:
- すべての処理がブラウザ内で完結
- 患者データは外部に送信されません
- 処理済みキーのみlocalStorageに保存（暗号化なし）

⚠️ **注意**:
- ブラウザのlocalStorageに処理済みキーが保存されます
- 共有PCでは使用後にキャッシュをクリアしてください

### ブラウザキャッシュクリア方法

```
Chrome/Edge: Ctrl + Shift + Delete → 「キャッシュされた画像とファイル」と「Cookieとサイトデータ」を選択 → クリア

Firefox: Ctrl + Shift + Delete → 「キャッシュ」と「サイトデータ」を選択 → 今すぐ消去

Safari: 環境設定 → プライバシー → Webサイトデータを管理 → すべてを削除
```

---

## 📦 ファイル構成

```
standalone-app/
├── index.html              # メインHTMLファイル（これを開く）
├── app.js                  # JavaScriptロジック
├── tyouzai_excel_v2.xlsx   # 旭川市公式Excelテンプレート
└── README.md               # このファイル
```

**特徴**:
- ファイル数: 4つ（最小構成）
- 外部依存: CDN経由でライブラリ読み込み
  - Papa Parse 5.4.1（CSV解析）
  - ExcelJS 4.4.0（Excel生成）
  - encoding-japanese 2.0.0（Shift-JISエンコーディング対応）
- テンプレート: ユーザーがファイル選択で指定（完全オフライン動作）

---

## 🆚 webapp-version との違い

| 項目 | standalone-app | webapp-version |
|-----|---------------|---------------|
| **サーバー** | 不要（file://で動作） | 必要（HTTPサーバー） |
| **インストール** | 不要 | Python等が必要 |
| **ライブラリ** | CDN読み込み | ローカルモジュール |
| **アーカイブ** | localStorage（簡易） | IndexedDB（高機能） |
| **テンプレート** | ユーザー選択（初回必須） | 組み込み |
| **起動方法** | ダブルクリック | `python -m http.server` |
| **オフライン動作** | ◎（完全オフライン） | ◎（完全オフライン） |
| **適用シーン** | 個人利用、簡易導入 | 組織導入、高度な機能 |

---

## 🔄 更新履歴

### v2.0.0（2025-02-15）
- ✨ スタンドアロン版初回リリース
- ✨ CDN経由でライブラリ読み込み
- ✨ file://プロトコル対応
- ✨ テンプレート動的ダウンロード
- ✨ localStorage簡易アーカイブ

---

## 📞 サポート

### お問い合わせ

**開発者**: 関根 (sekine53629)
**GitHub**: https://github.com/[user]/welfare-dispensing-invoice-generator

### 旭川市への請求に関するお問い合わせ

**部署**: 旭川市福祉保険部 生活支援課 医療介護係
**電話**: 0166-25-9121
**住所**: 〒070-8525 北海道旭川市7条通9丁目48番地 総合庁舎5階

---

## 📄 ライセンス

このソフトウェアは個人・商用利用ともに無料でご利用いただけます。

**使用ライブラリ**:
- Papa Parse (MIT License)
- ExcelJS (MIT License)

---

## 🎉 まとめ

このスタンドアロン版は、**インストール不要で即座に使える**請求書作成ツールです。

### 3ステップで完了

1. **index.htmlを開く** （ダブルクリック）
2. **CSVをアップロード** （ドラッグ&ドロップ）
3. **Excelダウンロード** （ボタンクリック）

**所要時間**: 約1-2分

薬局業務の効率化にお役立てください！ 🚀
