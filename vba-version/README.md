# 調剤券請求書作成ツール - VBA版

## 概要
Microsoft Excel VBAで実装された生活保護調剤券請求書自動作成ツールです。
Excelマクロ有効ブック（.xlsm）として動作します。

## 動作環境
- **OS**: Windows 10/11
- **Excel**: Microsoft Excel 2016/2019/365
- **必要な権限**: マクロ実行許可

## ディレクトリ構成
```
vba-version/
├── modules/                    # VBAモジュール（.basファイル）
│   ├── Module_Main.bas         # メイン制御
│   ├── Module_CSVParser.bas    # CSV解析
│   ├── Module_DataFilter.bas   # データフィルタリング
│   ├── Module_ExcelExport.bas  # Excel出力
│   ├── Module_Archive.bas      # アーカイブ管理
│   └── Module_Config.bas       # 設定管理
├── templates/                  # Excelテンプレート
│   └── tyouzai_excel_2.xltx
├── archive/                    # アーカイブデータ（自動生成）
└── 調剤券請求書作成.xlsm        # メインブック
```

## インストール方法

### 方法1: 完成版を使用（推奨）
1. `調剤券請求書作成.xlsm` を任意の場所にコピー
2. Excelで開く
3. マクロを有効化

### 方法2: モジュールから構築
1. 新しいExcelブックを作成
2. VBAエディタを開く（Alt+F11）
3. `modules/`内の各`.bas`ファイルをインポート
   - ファイル → ファイルのインポート → .basファイルを選択
4. マクロ有効ブック（.xlsm）として保存

### 方法3: インポートツールを使用
```bash
# Python環境が必要
cd ../tool
python vba_import_gui_v2.py
```

## 使用方法

### 初回設定
1. `調剤券請求書作成.xlsm`を開く
2. Sheet1（設定シート）で以下を入力:
   - **B1**: 薬局名
   - **B2**: 医療機関コード（10桁）
3. 「テンプレート設定」ボタンをクリック
   - テンプレート保存先フォルダを選択
   - 請求書保存先フォルダを選択
4. 設定が自動保存される（B3, B4に保存）

### 請求書作成（1回目）
1. 「調剤券データ取り込み」ボタンをクリック
2. CSVファイルを選択
3. 自動処理:
   - 旭川市生活保護受給者のみ抽出
   - 公費番号チェック（12番）
   - 自立支援・重障判定
   - 請求書生成
4. 完了メッセージで保存先を確認
5. **重要**: 処理したデータが自動アーカイブされる

### 請求書作成（2回目 - 月末）
1. 「調剤券データ取り込み（2回目）」ボタンをクリック
2. CSVファイルを選択
3. 自動処理:
   - 1回目処理済みデータと照合
   - 重複レコードを除外
   - 新規分のみ請求書生成
4. 完了メッセージで保存先を確認

## 機能詳細

### CSV解析
- **対応形式**: Shift-JIS、カンマ区切り
- **特殊処理**:
  - 不完全なシングルクォートの修正
  - カンマを含むフィールドの正しい解析
  - 70列のデータ構造に対応

### データフィルタリング
- **住所フィルター**: 「旭川市」を含むレコードのみ
- **公費番号フィルター**: 種別番号「12」（生活保護）
- **重複チェック**: 受給者番号 + 診療日 + 氏名

### 公費判定
- **自立支援**: 種別番号 21/15/16 → ○印
- **重度障害**: 種別番号 54 → ○印

### アーカイブ機能
- **保存先**: `archive/YYYY/YYYYMM/batch*_YYYYMMDD/`
- **保存内容**:
  - 元CSVファイル
  - 生成Excel
  - 処理ログ
- **保存期間**: 5年間（1,825日）

## トラブルシューティング

### マクロが実行できない
- **原因**: マクロのセキュリティ設定
- **解決**:
  1. ファイル → オプション → セキュリティセンター
  2. マクロの設定 → 警告を表示してすべてのマクロを有効にする

### CSVが正しく読み込めない
- **原因**: 文字エンコーディング
- **解決**: CSVファイルがShift-JISであることを確認

### テンプレートが見つからない
- **原因**: 設定シート（Sheet1）のB3が空
- **解決**: 「テンプレート設定」を再実行

### 重複チェックが動作しない
- **原因**: アーカイブフォルダが存在しない
- **解決**: `archive/`フォルダを手動作成

## 開発者向け情報

### モジュール構成
```
Module_Main
  ├── SetupTemplate()        # 初期設定
  └── ExportTyouzaiken()     # メイン処理

Module_CSVParser
  ├── ParseCSVFile()         # CSV読み込み
  └── FixQuoteIssues()       # クォート修正

Module_DataFilter
  ├── FilterAsahikawa()      # 旭川市フィルター
  ├── FilterPublicCode12()   # 生活保護フィルター
  └── CheckDuplicate()       # 重複チェック

Module_ExcelExport
  ├── CreateWorkbook()       # ブック作成
  ├── WriteData()            # データ書き込み
  └── SaveWorkbook()         # 保存

Module_Archive
  ├── ArchiveData()          # アーカイブ保存
  └── CleanOldArchives()     # 古いデータ削除

Module_Config
  ├── LoadConfig()           # 設定読み込み
  └── SaveConfig()           # 設定保存
```

### デバッグ方法
1. VBAエディタ（Alt+F11）を開く
2. ブレークポイント設定（F9）
3. ステップ実行（F8）
4. イミディエイトウィンドウ（Ctrl+G）で変数確認

### テスト
- サンプルCSV: `../shared/sample-data/調剤券請求書CSV202502.csv`
- 期待される出力: 6件のレコード（旭川市生活保護のみ）

## ライセンス
MIT License

## 作成者
関根 sekine53629

## バージョン履歴
- **v2.0.0** (2025-02): モジュール分割、アーカイブ機能追加
- **v1.0.0** (旧版): 単一モジュール版（archive/Module1.bas）

## サポート
- GitHub Issues: https://github.com/sekine53629/welfare-dispensing-invoice-generator/issues
- Email: （必要に応じて追加）
